
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Otel Fiyat Scraper</title>
    <link rel="stylesheet" href="/css/scraper-style.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üè® Otel Fiyat Analizi Sistemi</h1>
            <nav class="nav">
                <a href="/" class="nav-link active">Ana Sayfa</a>
                <a href="/hotel-management" class="nav-link">Otel Y√∂netimi</a>
            </nav>
        </header>

        <main class="main-content">
            <h2>Otel Fiyat Analizi</h2>

    <form action="/scrape" method="POST">
        <div class="form-group">
            <label for="hotelSearch">Otel Ara:</label>
            <div class="search-container">
                <input type="text" id="hotelSearch" placeholder="Otel adƒ±nƒ± yazƒ±n..." autocomplete="off">
                <div id="searchResults" class="search-results"></div>
            </div>
        </div>
        
        <div class="form-group">
            <label for="urls">Se√ßilen Oteller:</label>
            <div id="selectedHotels" class="selected-hotels"></div>
            <textarea id="urls" name="urls" rows="3" required style="display: none;"></textarea>
        </div>

        <div class="form-group-inline">
            <div class="form-group">
                <label for="startDate">Ba≈ülangƒ±√ß Tarihi:</label>
                <input type="date" id="startDate" name="startDate" required>
            </div>
            <div class="form-group">
                <label for="endDate">Biti≈ü Tarihi:</label>
                <input type="date" id="endDate" name="endDate" required>
            </div>
        </div>

        <div class="form-group">
            <label for="adultCount">Yeti≈ükin Sayƒ±sƒ±:</label>
            <input type="number" id="adultCount" name="adultCount" min="1" value="2" required>
        </div>

        <div class="form-group">
            <label for="childCount">√áocuk Sayƒ±sƒ±:</label>
            <input type="number" id="childCount" name="childCount" min="0" max="4" value="0" required>
        </div>

        <div class="form-group" id="childAgesContainer" style="display: none;">
            <label>√áocuk Ya≈ülarƒ±:</label>
            <div id="childAgesInputs"></div>
        </div>

        <button type="submit">Fiyatlarƒ± Getir</button>
    </form>

    <% if (error) { %>
        <p class="error"><%= error %></p>
    <% } %>

    <% if (results && results.length > 0) { %>
        <h2>Sonu√ßlar</h2>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Otel Adƒ±</th>
                        <% const dates = Object.keys(results[0].prices || {}); %>
                        <% dates.forEach(date => { %>
                            <th><%= new Date(date).toLocaleDateString('tr-TR', { day: '2-digit', month: 'short' }) %></th>
                        <% }); %>
                    </tr>
                </thead>
                <tbody>
                    <% results.forEach(result => { %>
                        <tr>
                            <td><%= result.hotelName %></td>
                            <% if (result.error) { %>
                                <td colspan="<%= dates.length %>" class="error"><%= result.error %></td>
                            <% } else { %>
                                <% dates.forEach(date => { %>
                                    <td>
                                        <% const price = result.prices[date]; %>
                                        <%= price !== 'Fiyat bulunamadƒ±' ? price.toFixed(2) + ' TL' : '-' %>
                                    </td>
                                <% }); %>
                            <% } %>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>
    <% } %>

    <script>
        let selectedHotels = [];
        let searchTimeout;

        document.getElementById('hotelSearch').addEventListener('input', function(e) {
            const query = e.target.value.trim();
            
            clearTimeout(searchTimeout);
            
            if (query.length < 2) {
                hideSearchResults();
                return;
            }

            searchTimeout = setTimeout(() => {
                searchHotels(query);
            }, 300);
        });

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container')) {
                hideSearchResults();
            }
        });

        async function searchHotels(query) {
            try {
                const response = await fetch(`/api/search-hotels?query=${encodeURIComponent(query)}`);
                const data = await response.json();
                displaySearchResults(data.hotels);
            } catch (error) {
                console.error('Otel arama hatasƒ±:', error);
                displaySearchResults([]);
            }
        }

        function displaySearchResults(hotels) {
            const resultsContainer = document.getElementById('searchResults');
            
            if (hotels.length === 0) {
                resultsContainer.innerHTML = '<div class="search-result-item">Sonu√ß bulunamadƒ±</div>';
                resultsContainer.style.display = 'block';
                return;
            }

            resultsContainer.innerHTML = hotels.map(hotel => `
                <div class="search-result-item" onclick="selectHotel('${hotel.id}', '${hotel.name}', '${hotel.city}', '${hotel.url}', '${hotel.image || ''}')">
                    <img src="${hotel.image || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiBmaWxsPSIjRjBGMEYwIi8+CjxwYXRoIGQ9Ik0xNSAyMEgzNVYzNUgxNVYyMFoiIGZpbGw9IiNDQ0NDQ0MiLz4KPHBhdGggZD0iTTEwIDE1SDQwVjIwSDEwVjE1WiIgZmlsbD0iI0NDQ0NDQyIvPgo8L3N2Zz4K'}" alt="${hotel.name}" class="hotel-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiBmaWxsPSIjRjBGMEYwIi8+CjxwYXRoIGQ9Ik0xNSAyMEgzNVYzNUgxNVYyMFoiIGZpbGw9IiNDQ0NDQ0MiLz4KPHBhdGggZD0iTTEwIDE1SDQwVjIwSDEwVjE1WiIgZmlsbD0iI0NDQ0NDQyIvPgo8L3N2Zz4K'">
                    <div class="hotel-info">
                        <div class="hotel-name">${hotel.name}</div>
                        <div class="hotel-city">${hotel.city}</div>
                    </div>
                </div>
            `).join('');
            
            resultsContainer.style.display = 'block';
        }

        function hideSearchResults() {
            document.getElementById('searchResults').style.display = 'none';
        }

        function selectHotel(id, name, city, url, image) {
            // Aynƒ± oteli tekrar eklemeyi √∂nle
            if (selectedHotels.find(hotel => hotel.id === id)) {
                return;
            }

            const hotel = { id, name, city, url, image };
            selectedHotels.push(hotel);
            
            updateSelectedHotelsDisplay();
            updateUrlsTextarea();
            
            // Arama alanƒ±nƒ± temizle
            document.getElementById('hotelSearch').value = '';
            hideSearchResults();
        }

        function removeHotel(hotelId) {
            selectedHotels = selectedHotels.filter(hotel => hotel.id !== hotelId);
            updateSelectedHotelsDisplay();
            updateUrlsTextarea();
        }

        function updateSelectedHotelsDisplay() {
            const container = document.getElementById('selectedHotels');
            
            if (selectedHotels.length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">Hen√ºz otel se√ßilmedi</p>';
                return;
            }

            container.innerHTML = selectedHotels.map(hotel => `
                <div class="selected-hotel">
                    <div class="selected-hotel-info">
                        <img src="${hotel.image || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiBmaWxsPSIjRjBGMEYwIi8+CjxwYXRoIGQ9Ik0xNSAyMEgzNVYzNUgxNVYyMFoiIGZpbGw9IiNDQ0NDQ0MiLz4KPHBhdGggZD0iTTEwIDE1SDQwVjIwSDEwVjE1WiIgZmlsbD0iI0NDQ0NDQyIvPgo8L3N2Zz4K'}" alt="${hotel.name}" class="hotel-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiBmaWxsPSIjRjBGMEYwIi8+CjxwYXRoIGQ9Ik0xNSAyMEgzNVYzNUgxNVYyMFoiIGZpbGw9IiNDQ0NDQ0MiLz4KPHBhdGggZD0iTTEwIDE1SDQwVjIwSDEwVjE1WiIgZmlsbD0iI0NDQ0NDQyIvPgo8L3N2Zz4K'">
                        <div>
                            <div class="hotel-name">${hotel.name}</div>
                            <div class="hotel-city">${hotel.city}</div>
                        </div>
                    </div>
                    <button type="button" class="remove-hotel" onclick="removeHotel('${hotel.id}')" title="Kaldƒ±r">√ó</button>
                </div>
            `).join('');
        }

        function updateUrlsTextarea() {
            const urls = selectedHotels.map(hotel => hotel.url).join('\n');
            document.getElementById('urls').value = urls;
        }

        // √áocuk sayƒ±sƒ± deƒüi≈ütiƒüinde ya≈ü input'larƒ±nƒ± g√ºncelle
        document.getElementById('childCount').addEventListener('change', function() {
            updateChildAgesInputs();
        });

        function updateChildAgesInputs() {
            const childCount = parseInt(document.getElementById('childCount').value) || 0;
            const container = document.getElementById('childAgesContainer');
            const inputsDiv = document.getElementById('childAgesInputs');
            
            if (childCount > 0) {
                container.style.display = 'block';
                inputsDiv.innerHTML = '';
                
                for (let i = 0; i < childCount; i++) {
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.name = `childAge${i}`;
                    input.min = '0';
                    input.max = '17';
                    input.placeholder = `${i + 1}. √ßocuk ya≈üƒ±`;
                    input.required = true;
                    input.style.marginBottom = '5px';
                    input.style.width = '100%';
                    input.style.padding = '8px';
                    input.style.border = '1px solid #ccc';
                    input.style.borderRadius = '4px';
                    input.style.boxSizing = 'border-box';
                    
                    inputsDiv.appendChild(input);
                }
            } else {
                container.style.display = 'none';
            }
        }

        // Form submit edilmeden √∂nce √ßocuk ya≈ülarƒ±nƒ± topla
        document.querySelector('form').addEventListener('submit', function(e) {
            const childCount = parseInt(document.getElementById('childCount').value) || 0;
            const childAges = [];
            
            for (let i = 0; i < childCount; i++) {
                const ageInput = document.querySelector(`input[name="childAge${i}"]`);
                if (ageInput && ageInput.value) {
                    childAges.push(parseInt(ageInput.value));
                }
            }
            
            // √áocuk ya≈ülarƒ±nƒ± hidden input'a ekle
            let hiddenInput = document.getElementById('childAges');
            if (!hiddenInput) {
                hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.id = 'childAges';
                hiddenInput.name = 'childAges';
                document.querySelector('form').appendChild(hiddenInput);
            }
            hiddenInput.value = JSON.stringify(childAges);
        });

        // Sayfa y√ºklendiƒüinde se√ßili otelleri g√∂ster ve √ßocuk ya≈ülarƒ±nƒ± g√ºncelle
        document.addEventListener('DOMContentLoaded', function() {
            updateSelectedHotelsDisplay();
            updateChildAgesInputs();
        });
    </script>
        </main>
    </div>
</body>
</html>
