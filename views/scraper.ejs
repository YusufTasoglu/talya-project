
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Otel Fiyat Scraper</title>
    <link rel="stylesheet" href="/css/scraper-style.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üè® Otel Fiyat Analizi Sistemi</h1>
            <nav class="nav">
                <a href="/" class="nav-link">Otel Y√∂netimi</a>
                <a href="/scraper" class="nav-link active">Fiyat Analizi</a>
            </nav>
        </header>

        <main class="main-content">
            <h2>Otel Fiyat Analizi</h2>

            <!-- Kaydedilen Otel Bilgileri -->
            <div class="hotel-info-section">
                <h3>üìä Analiz Edilecek Oteller</h3>
                <div id="hotelsToAnalyze" class="hotels-to-analyze">
                    <p class="loading">Otel bilgileri y√ºkleniyor...</p>
                </div>
            </div>

    <form action="/scrape" method="POST">
        <div class="form-header">
            <h3>üìã Fiyat Analizi Parametreleri</h3>
            <p>Analiz yapƒ±lacak tarih aralƒ±ƒüƒ± ve misafir bilgilerini giriniz</p>
        </div>

        <div class="form-group-inline">
            <div class="form-group">
                <label for="startDate">Ba≈ülangƒ±√ß Tarihi:</label>
                <input type="date" id="startDate" name="startDate" required>
            </div>
            <div class="form-group">
                <label for="endDate">Biti≈ü Tarihi:</label>
                <input type="date" id="endDate" name="endDate" required>
            </div>
        </div>

        <div class="form-group">
            <label for="adultCount">Yeti≈ükin Sayƒ±sƒ±:</label>
            <input type="number" id="adultCount" name="adultCount" min="1" value="2" required>
        </div>

        <div class="form-group">
            <label for="childCount">√áocuk Sayƒ±sƒ±:</label>
            <input type="number" id="childCount" name="childCount" min="0" max="4" value="0" required>
        </div>

        <div class="form-group" id="childAgesContainer" style="display: none;">
            <label>√áocuk Ya≈ülarƒ±:</label>
            <div id="childAgesInputs"></div>
        </div>

        <button type="submit">Fiyatlarƒ± Getir</button>
    </form>

    <% if (error) { %>
        <p class="error"><%= error %></p>
    <% } %>

    <% if (results && results.length > 0) { %>
        <h2>Fiyat Analizi Sonu√ßlarƒ±</h2>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Otel Adƒ±</th>
                        <% const dates = Object.keys(results[0].prices || {}); %>
                        <% dates.forEach(date => { %>
                            <th><%= new Date(date).toLocaleDateString('tr-TR', { day: '2-digit', month: 'short' }) %></th>
                        <% }); %>
                    </tr>
                </thead>
                <tbody>
                    <% 
                    // Kendi otelimizi ve rakip otelleri ayƒ±r
                    const ownHotel = results.find(result => result.isOwnHotel);
                    const competitorHotels = results.filter(result => !result.isOwnHotel);
                    
                    // √ñnce rakip otelleri g√∂ster
                    competitorHotels.forEach(result => { 
                    %>
                        <tr>
                            <td><%= result.hotelName %></td>
                            <% if (result.error) { %>
                                <td colspan="<%= dates.length %>" class="error"><%= result.error %></td>
                            <% } else { %>
                                <% dates.forEach(date => { %>
                                    <td class="price-cell" data-date="<%= date %>" data-price="<%= result.prices[date] %>">
                                        <% const price = result.prices[date]; %>
                                        <%= price !== 'Fiyat bulunamadƒ±' ? price.toFixed(2) + ' TL' : '-' %>
                                    </td>
                                <% }); %>
                            <% } %>
                        </tr>
                    <% }); %>
                    
                    <% if (ownHotel) { %>
                        <tr class="own-hotel-row">
                            <td><%= ownHotel.hotelName %></td>
                            <% if (ownHotel.error) { %>
                                <td colspan="<%= dates.length %>" class="error"><%= ownHotel.error %></td>
                            <% } else { %>
                                <% dates.forEach(date => { %>
                                    <td class="price-cell" data-date="<%= date %>" data-price="<%= ownHotel.prices[date] %>">
                                        <% const price = ownHotel.prices[date]; %>
                                        <%= price !== 'Fiyat bulunamadƒ±' ? price.toFixed(2) + ' TL' : '-' %>
                                    </td>
                                <% }); %>
                            <% } %>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
        
        <% if (results && results.length > 0) { %>
        <script>
            // En ucuz fiyatlarƒ± i≈üaretle
            document.addEventListener('DOMContentLoaded', function() {
                const dates = <%- JSON.stringify(Object.keys(results[0].prices || {})) %>;
                
                dates.forEach(date => {
                    const priceCells = document.querySelectorAll(`[data-date="${date}"]`);
                    let minPrice = Infinity;
                    let minPriceCell = null;
                    
                    priceCells.forEach(cell => {
                        const priceText = cell.textContent.trim();
                        if (priceText !== '-' && priceText !== 'Fiyat bulunamadƒ±') {
                            const price = parseFloat(priceText.replace(' TL', ''));
                            if (price < minPrice) {
                                minPrice = price;
                                minPriceCell = cell;
                            }
                        }
                    });
                    
                    if (minPriceCell) {
                        minPriceCell.classList.add('cheapest-price');
                    }
                });
            });
        </script>
        <% } %>
    <% } %>

    <script>
        let hotelsToAnalyze = [];

        // Sayfa y√ºklendiƒüinde otel bilgilerini y√ºkle
        document.addEventListener('DOMContentLoaded', function() {
            loadHotelData();
            updateChildAgesInputs();
        });

        // Kaydedilen otel verilerini y√ºkle
        async function loadHotelData() {
            try {
                const response = await fetch('/api/get-hotels');
                const data = await response.json();
                
                hotelsToAnalyze = [];
                
                if (data.ownHotel) {
                    hotelsToAnalyze.push({
                        ...data.ownHotel,
                        type: 'own'
                    });
                }
                
                if (data.competitors && data.competitors.length > 0) {
                    data.competitors.forEach(competitor => {
                        hotelsToAnalyze.push({
                            ...competitor,
                            type: 'competitor'
                        });
                    });
                }
                
                displayHotelsToAnalyze();
            } catch (error) {
                console.error('Otel verileri y√ºklenirken hata:', error);
                document.getElementById('hotelsToAnalyze').innerHTML = 
                    '<p class="error">Otel verileri y√ºklenemedi. L√ºtfen √∂nce <a href="/">otel y√∂netimi</a> sayfasƒ±ndan otelleri tanƒ±mlayƒ±n.</p>';
            }
        }

        // Analiz edilecek otelleri g√∂ster
        function displayHotelsToAnalyze() {
            const container = document.getElementById('hotelsToAnalyze');
            
            if (hotelsToAnalyze.length === 0) {
                container.innerHTML = `
                    <div class="no-hotels">
                        <p>Hen√ºz analiz edilecek otel tanƒ±mlanmamƒ±≈ü.</p>
                        <a href="/" class="btn btn-primary">Otel Y√∂netimi Sayfasƒ±na Git</a>
                    </div>
                `;
                return;
            }

            container.innerHTML = hotelsToAnalyze.map(hotel => `
                <div class="hotel-to-analyze ${hotel.type}">
                    <div class="hotel-badge">
                        ${hotel.type === 'own' ? 'üè† Kendi Oteliniz' : 'üéØ Rakip Otel'}
                    </div>
                    <div class="hotel-details">
                        <div class="hotel-name">${hotel.name}</div>
                        <div class="hotel-city">${hotel.city}</div>
                    </div>
                </div>
            `).join('');
        }

        // √áocuk sayƒ±sƒ± deƒüi≈ütiƒüinde ya≈ü input'larƒ±nƒ± g√ºncelle
        document.getElementById('childCount').addEventListener('change', function() {
            updateChildAgesInputs();
        });

        function updateChildAgesInputs() {
            const childCount = parseInt(document.getElementById('childCount').value) || 0;
            const container = document.getElementById('childAgesContainer');
            const inputsDiv = document.getElementById('childAgesInputs');
            
            if (childCount > 0) {
                container.style.display = 'block';
                inputsDiv.innerHTML = '';
                
                for (let i = 0; i < childCount; i++) {
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.name = `childAge${i}`;
                    input.min = '0';
                    input.max = '17';
                    input.placeholder = `${i + 1}. √ßocuk ya≈üƒ±`;
                    input.required = true;
                    input.style.marginBottom = '5px';
                    input.style.width = '100%';
                    input.style.padding = '8px';
                    input.style.border = '1px solid #ccc';
                    input.style.borderRadius = '4px';
                    input.style.boxSizing = 'border-box';
                    
                    inputsDiv.appendChild(input);
                }
            } else {
                container.style.display = 'none';
            }
        }

        // Form submit edilmeden √∂nce √ßocuk ya≈ülarƒ±nƒ± topla
        document.querySelector('form').addEventListener('submit', function(e) {
            const childCount = parseInt(document.getElementById('childCount').value) || 0;
            const childAges = [];
            
            for (let i = 0; i < childCount; i++) {
                const ageInput = document.querySelector(`input[name="childAge${i}"]`);
                if (ageInput && ageInput.value) {
                    childAges.push(parseInt(ageInput.value));
                }
            }
            
            // √áocuk ya≈ülarƒ±nƒ± hidden input'a ekle
            let hiddenInput = document.getElementById('childAges');
            if (!hiddenInput) {
                hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.id = 'childAges';
                hiddenInput.name = 'childAges';
                document.querySelector('form').appendChild(hiddenInput);
            }
            hiddenInput.value = JSON.stringify(childAges);
        });

        // Form submit edilmeden √∂nce kontrol
        document.querySelector('form').addEventListener('submit', function(e) {
            if (hotelsToAnalyze.length === 0) {
                e.preventDefault();
                alert('Analiz edilecek otel bulunamadƒ±. L√ºtfen √∂nce otel y√∂netimi sayfasƒ±ndan otelleri tanƒ±mlayƒ±n.');
                return;
            }
            
            const childCount = parseInt(document.getElementById('childCount').value) || 0;
            const childAges = [];
            
            for (let i = 0; i < childCount; i++) {
                const ageInput = document.querySelector(`input[name="childAge${i}"]`);
                if (ageInput && ageInput.value) {
                    childAges.push(parseInt(ageInput.value));
                }
            }
            
            // √áocuk ya≈ülarƒ±nƒ± hidden input'a ekle
            let hiddenInput = document.getElementById('childAges');
            if (!hiddenInput) {
                hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.id = 'childAges';
                hiddenInput.name = 'childAges';
                document.querySelector('form').appendChild(hiddenInput);
            }
            hiddenInput.value = JSON.stringify(childAges);
        });
    </script>
        </main>
    </div>
</body>
</html>
